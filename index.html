<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>S·∫ßu ri√™ng Cam ‚Äì G√°n nh√£n nhanh</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2a; --accent:#4ade80; --muted:#94a3b8; --danger:#ef4444;}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:#e5e7eb}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px} @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{cursor:pointer;border:1px solid rgba(255,255,255,.08);background:#172033;color:#e5e7eb;border-radius:12px;padding:10px 14px;font-weight:600}
    .primary{background:var(--accent);color:#04120b;border-color:transparent}
    .ghost{background:transparent} .warn{background:var(--danger);color:white;border-color:transparent}
    .small{padding:6px 10px;border-radius:10px}
    label{font-size:12px;color:var(--muted)} input,select{background:#0d1727;border:1px solid rgba(255,255,255,.1);border-radius:10px;color:#e5e7eb;padding:9px 10px}
    video,canvas,img{width:100%;border-radius:12px;background:#000}
    .pill{border-radius:999px;padding:4px 10px;background:#0f172a;border:1px solid rgba(255,255,255,.08);font-size:12px;color:#cbd5e1}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1220;border:1px solid rgba(255,255,255,.1);padding:2px 6px;border-radius:6px}
    .list{max-height:220px;overflow:auto;border:1px dashed rgba(255,255,255,.12);padding:8px;border-radius:12px}
    .muted{color:var(--muted)} .angle{padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.1)}
    .ok{color:#4ade80}
  </style>
</head>
<body>
<div class="wrap grid">
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:6px 0">S·∫ßu ri√™ng Cam ‚Äì G√°n nh√£n nhanh</h2>
      <div class="pill">PWA + Google Drive upload</div>
    </div>

    <!-- auth / drive status -->
    <div class="row" style="margin-bottom:8px">
      <button id="btnSignIn" class="primary">üîê ƒêƒÉng nh·∫≠p Google</button>
      <div id="authState" class="pill">Ch∆∞a ƒëƒÉng nh·∫≠p</div>
      <div id="driveState" class="pill">Th∆∞ m·ª•c: (ch∆∞a t·∫°o)</div>
    </div>

    <video id="video" playsinline autoplay muted></video>
    <div class="row" style="margin-top:10px">
      <button id="btnStart" class="primary">üé• B·∫≠t camera</button>
      <button id="btnFlip" class="ghost">üîÑ ƒê·ªïi camera</button>
      <button id="btnShot">üì∏ Ch·ª•p</button>
      <button id="btnUndo" class="ghost small">‚Ü©Ô∏è Ho√†n t√°c</button>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>M√£ tr√°i</label><br/>
        <input id="fruitId" size="8"/>
        <button id="nextId" class="small">+1</button>
      </div>
      <div>
        <label>Nh√£n</label><br/>
        <select id="label">
          <option value="dep">ƒë·∫πp</option>
          <option value="suong">s∆∞·ª£ng</option>
          <option value="hatlep">h·∫°t_l√©p</option>
          <option value="xau">x·∫•u</option>
        </select>
      </div>
      <div>
        <label>G√≥c</label><br/>
        <div class="row">
          <button class="small angle" data-angle="1">1</button>
          <button class="small angle" data-angle="2">2</button>
          <button class="small angle" data-angle="3">3</button>
          <button class="small angle" data-angle="4">4</button>
          <button class="small angle" data-angle="5">5</button>
        </div>
      </div>
      <div>
        <label>T√™n file (auto)</label><br/>
        <div id="fname" class="pill">SR001_dep_1.jpg</div>
      </div>
    </div>
    <p class="muted">Quy ∆∞·ªõc t√™n: <span class="kbd">&lt;ID&gt;_&lt;label&gt;_&lt;angle&gt;.jpg</span></p>
  </section>

  <section class="card">
    <h3 style="margin-top:4px">B·ªô s∆∞u t·∫≠p</h3>
    <div class="list" id="shots"></div>
    <div class="row" style="margin-top:10px">
      <button id="btnExport" class="primary">üíæ Xu·∫•t ZIP (·∫£nh + labels.csv)</button>
      <button id="btnClear" class="warn">üóë X√≥a t·∫•t c·∫£</button>
    </div>
    <p class="muted">CSV: <span class="kbd">filename,id,label,angle,time,drive_file_id</span></p>
  </section>
</div>

<canvas id="canvas" style="display:none"></canvas>

<!-- Google API -->
<script src="https://apis.google.com/js/api.js"></script>
<script>
/*** ====== C·∫§U H√åNH GOOGLE OAUTH ====== ***/
const CLIENT_ID = "973725538670-0ddgbgokodh9f9i2o4l0ersgs9uq2551.apps.googleusercontent.com";
const SCOPES = "https://www.googleapis.com/auth/drive.file";
const DRIVE_FOLDER_NAME = "Durian Label";

/*** ====== STATE ====== ***/
let stream, currentDeviceId=null, devices=[], angle=1;
let folderId = localStorage.getItem("durian_drive_folder") || null;
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const shotsDiv = document.getElementById('shots');
const fruitId = document.getElementById('fruitId');
const labelSel = document.getElementById('label');
const fname = document.getElementById('fname');
const authState = document.getElementById('authState');
const driveState = document.getElementById('driveState');
const db = []; // {blob, filename, id, label, angle, time, driveId}

function pad3(n){return String(n).padStart(3,'0')}
function suggestName(){ fname.textContent = `${fruitId.value}_${labelSel.value}_${angle}.jpg`; }

/*** ====== AUTO ID ====== ***/
(function initId(){
  let last = localStorage.getItem('durian_last_id') || 'SR000';
  const m = last.match(/^(\D+)(\d+)$/);
  let next = (m? m[1] : 'SR') + pad3((m? parseInt(m[2],10):0)+1);
  fruitId.value = next;
  suggestName();
})();

/*** ====== CAMERA ====== ***/
async function getCams(){ const all = await navigator.mediaDevices.enumerateDevices(); devices = all.filter(d=>d.kind==='videoinput'); }
async function startCamera(){
  if(stream){stream.getTracks().forEach(t=>t.stop());}
  await getCams();
  let constraints = { video: { facingMode: 'environment' } };
  if(currentDeviceId){ constraints = { video: { deviceId: { exact: currentDeviceId } } } }
  stream = await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject = stream; await video.play();
}
async function flipCamera(){
  await getCams(); if(!devices.length) return;
  const curIdx = devices.findIndex(d=>d.deviceId===currentDeviceId);
  const nextIdx = curIdx<0 ? 0 : (curIdx+1)%devices.length;
  currentDeviceId = devices[nextIdx].deviceId;
  await startCamera();
}

/*** ====== GOOGLE AUTH + DRIVE ====== ***/
function setAuthUI(){
  const isSignedIn = gapi.auth2.getAuthInstance()?.isSignedIn.get();
  authState.textContent = isSignedIn ? "ƒê√£ ƒëƒÉng nh·∫≠p" : "Ch∆∞a ƒëƒÉng nh·∫≠p";
}

function ensureGapiClient(){
  return new Promise(res=>{
    gapi.load('client:auth2', async ()=>{
      await gapi.client.init({
        clientId: CLIENT_ID,
        scope: SCOPES
      });
      setAuthUI();
      res();
    });
  });
}

async function signIn(){
  await ensureGapiClient();
  if (!gapi.auth2.getAuthInstance().isSignedIn.get()){
    await gapi.auth2.getAuthInstance().signIn();
  }
  setAuthUI();
  await ensureFolder();
}

async function fetchDrive(endpoint, method='GET', body=null, headers={}){
  const token = gapi.auth.getToken().access_token;
  const res = await fetch(`https://www.googleapis.com/drive/v3/${endpoint}`,{
    method,
    headers: { Authorization:`Bearer ${token}`, ...headers },
    body
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

async function ensureFolder(){
  if(!gapi.auth2.getAuthInstance().isSignedIn.get()){
    driveState.textContent = "Th∆∞ m·ª•c: (c·∫ßn ƒëƒÉng nh·∫≠p)";
    return;
  }
  if (folderId) { driveState.textContent = `Th∆∞ m·ª•c: ${DRIVE_FOLDER_NAME}`; return; }

  // t√¨m folder ƒë√£ do app t·∫°o (drive.file scope cho ph√©p th·∫•y file app ƒë√£ t·∫°o tr∆∞·ªõc ƒë√≥)
  const q = encodeURIComponent(`name='${DRIVE_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`);
  const res = await fetchDrive(`files?q=${q}&fields=files(id,name)`);
  if (res.files && res.files.length){
    folderId = res.files[0].id;
  } else {
    // t·∫°o m·ªõi
    const token = gapi.auth.getToken().access_token;
    const meta = { name: DRIVE_FOLDER_NAME, mimeType:'application/vnd.google-apps.folder' };
    const r = await fetch('https://www.googleapis.com/drive/v3/files',{
      method:'POST',
      headers:{ 'Authorization':`Bearer ${token}`, 'Content-Type':'application/json' },
      body: JSON.stringify(meta)
    });
    const js = await r.json();
    if(!r.ok) throw new Error(JSON.stringify(js));
    folderId = js.id;
  }
  localStorage.setItem('durian_drive_folder', folderId);
  driveState.textContent = `Th∆∞ m·ª•c: ${DRIVE_FOLDER_NAME}`;
}

async function uploadToDrive(row){
  if(!gapi.auth2.getAuthInstance().isSignedIn.get()){ return {driveId:null, note:'not_signed_in'}; }
  await ensureFolder();
  if(!folderId) return {driveId:null, note:'no_folder'};

  const token = gapi.auth.getToken().access_token;
  const metadata = {
    name: row.filename,
    parents: [folderId]
  };
  const boundary = '-------durian' + Math.random().toString(16).slice(2);
  const metaPart = `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}\r\n`;
  const blobPartHeader = `--${boundary}\r\nContent-Type: image/jpeg\r\n\r\n`;
  const end = `\r\n--${boundary}--`;

  const body = new Blob([metaPart, blobPartHeader, row.blob, end], {type:`multipart/related; boundary=${boundary}`});
  const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',{
    method:'POST',
    headers:{ 'Authorization':`Bearer ${token}` },
    body
  });
  const js = await resp.json();
  if(!resp.ok) throw new Error(JSON.stringify(js));
  return {driveId: js.id};
}

/*** ====== CAPTURE / UI ====== ***/
function addThumb(row){
  const url = URL.createObjectURL(row.blob);
  const el = document.createElement('div');
  el.className = 'row'; el.style.marginBottom = '6px';
  el.innerHTML = `<img src="${url}" style="width:96px;height:72px;object-fit:cover;border-radius:8px"/>`+
    `<div style="display:flex;flex-direction:column;gap:4px">`+
    `<div class="pill">${row.filename}</div>`+
    `<div class="muted">${new Date(row.time).toLocaleString()} ${row.driveId?` ‚Ä¢ <span class="ok">ƒê√£ up</span>`:''}</div>`+
    `</div>`;
  shotsDiv.prepend(el);
}

function rememberId(id){
  localStorage.setItem('durian_last_id', id);
}

function capture(){
  const w = video.videoWidth, h = video.videoHeight;
  if(!w||!h){ alert('Camera ch∆∞a s·∫µn s√†ng'); return; }
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,w,h);
  canvas.toBlob(async blob=>{
    const filename = `${fruitId.value}_${labelSel.value}_${angle}.jpg`;
    const row = { blob, filename, id: fruitId.value, label: labelSel.value, angle, time: new Date().toISOString(), driveId:null };
    db.push(row);
    addThumb(row);

    // upload ngay l√™n Drive
    try{
      const up = await uploadToDrive(row);
      row.driveId = up.driveId || null;
      addThumb(row); // th√™m 1 d√≤ng tr·∫°ng th√°i m·ªõi (nhanh g·ªçn)
    }catch(e){
      console.warn('Upload fail:', e);
    }

    // tƒÉng g√≥c, t·ª± tƒÉng ID khi ƒë·ªß 5 g√≥c
    if(angle<5){ angle++; } else {
      const m = fruitId.value.match(/^(\D+)(\d+)$/); 
      let next = (m? m[1]:'SR') + pad3((m? parseInt(m[2],10):0)+1);
      rememberId(next); fruitId.value = next; angle = 1;
    }
    suggestName();
  }, 'image/jpeg', 0.92);
}

function undo(){
  const last = db.pop(); if(!last) return;
  angle = last.angle; suggestName(); shotsDiv.firstChild?.remove();
}

/*** ====== EXPORT ZIP (D·ª∞ PH√íNG) ====== ***/
async function exportZip(){
  if(!db.length){ alert('Ch∆∞a c√≥ ·∫£nh'); return; }
  if(!window.JSZip){
    await new Promise((res,rej)=>{
      const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
      s.onload=res; s.onerror=()=>rej(new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c JSZip')); document.head.appendChild(s);
    });
  }
  const zip = new JSZip();
  const folder = zip.folder('images');
  let csv = 'filename,id,label,angle,time,drive_file_id\n';
  for (const r of db){
    folder.file(r.filename, r.blob);
    csv += `${r.filename},${r.id},${r.label},${r.angle},${r.time},${r.driveId||''}\n`;
  }
  zip.file('labels.csv', csv);
  const out = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(out);
  a.download = `durian_dataset_${new Date().toISOString().slice(0,10)}.zip`;
  a.click();
}

/*** ====== EVENT BINDINGS ====== ***/
document.getElementById('btnStart').onclick = startCamera;
document.getElementById('btnFlip').onclick = flipCamera;
document.getElementById('btnShot').onclick = capture;
document.getElementById('btnUndo').onclick = undo;
document.getElementById('btnExport').onclick = exportZip;
document.getElementById('btnClear').onclick = ()=>{ db.length=0; shotsDiv.innerHTML=''; };
document.getElementById('nextId').onclick = ()=>{
  const m = fruitId.value.match(/^(\D+)(\d+)$/); 
  if(!m){ fruitId.value+='001'; } else { fruitId.value = m[1] + pad3(parseInt(m[2],10)+1); }
  rememberId(fruitId.value); angle = 1; suggestName();
};
document.querySelectorAll('.angle').forEach(b=> b.onclick = ()=>{ angle = parseInt(b.dataset.angle,10); suggestName(); });
labelSel.onchange = suggestName; fruitId.oninput = suggestName; suggestName();

document.getElementById('btnSignIn').onclick = signIn;
// init gapi (kh√¥ng t·ª± sign-in)
ensureGapiClient().then(()=>{ ensureFolder().catch(()=>{}); });
</script>

<!-- PWA t·ªëi gi·∫£n ƒë·ªÉ Add to Home Screen -->
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    const sw = `self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>clients.claim());`;
    const blob = new Blob([sw],{type:'text/javascript'}); const url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url);
  });
}
</script>
</body>
</html>
